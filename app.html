<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning App</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="core/css/style.css">
    <link rel="stylesheet" href="core/css/mobile-console.css">
    
    <!-- 
     * AR Learning App - Phase 1: UI Structure Complete
     * 
     * Dependencies:
     * - CSS: core/css/style.css (all UI section styles)
     * - JS: core/js/topics.js (topic data and content)
     * - JS: core/js/stateManager.js (application state management)
     * 
     * Note: arSceneManager.js is disabled during Phase 1 UI development
     * Will be re-enabled for Phase 3: MindAR Integration
     -->
</head>
<body>
    <div id="debug">
        <button id="debug-toggle" onclick="toggleDebugConsole()">
            <span id="debug-info">v2.4 - loading</span>
            <span id="debug-arrow">▼</span>
        </button>
        <div id="debug-console" class="hidden">
            <div id="console-output"></div>
            <button id="copy-console-btn" onclick="copyConsoleToClipboard()">📋 Copy Console</button>
        </div>
    </div>

    <!-- Loading Section -->
    <div id="loading-section" class="card">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Loading Learning Experience</h2>
            <p>Preparing your interactive AR journey...</p>
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="loading-progress" class="progress-fill"></div>
                </div>
                <div class="progress-text">Initializing... <span id="loading-percentage">0%</span></div>
            </div>
        </div>
    </div>

    <!-- Campus Selection -->
    <div id="campus-selection" class="card hidden">
        <h1>Choose Your Campus</h1>
        <p>Select your preferred learning location</p>
        
        <div class="campus-grid">
            <div class="campus-card" onclick="selectCampus('broadmeadows')">
                <img src="./assets/misc/kangan.png" alt="Broadmeadows Campus" class="campus-logo">
                <div class="campus-name">Broadmeadows</div>
            </div>
            <div class="campus-card" onclick="selectCampus('bendigo')">
                <img src="./assets/misc/bendigo.png" alt="Bendigo Campus" class="campus-logo">
                <div class="campus-name">Bendigo</div>
            </div>
        </div>
    </div>

    <!-- Topic Selection -->
    <div id="topics" class="card hidden">
        <h1>Choose Your Learning Topic</h1>
        <p>Select a topic to begin your interactive learning experience</p>
        
        <div class="topic-grid" id="topic-grid-container">
            <!-- Topic cards will be dynamically populated from topics.js -->
        </div>
    </div>
    
    <!-- Menu Section -->
    <div id="menu-section" class="card hidden">
        <h1>Ready to Start AR Learning?</h1>
        <p>Your interactive AR journey is about to begin</p>
        
        <div class="completion-status">
            <div class="status-card">
                <span class="status-icon">📊</span>
                <div class="status-text">Progress</div>
                <div class="completion-count" id="progress-counter">0 of 4 completed</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
        </div>
        
        <div class="completed-topics" id="completed-topics-section" style="display: none;">
            <h3>Completed Topics</h3>
            <ul id="completed-topics-list" class="completed-topics-list">
                <!-- Completed topics will be populated here -->
            </ul>
        </div>
        
        <button class="btn btn-primary" onclick="startARScanning()">
            🚀 Start AR Scanning
        </button>
        
        <div class="menu-info">
            <p>📱 Point your camera at one of the learning posters</p>
            <p>🎯 Each poster will unlock a different learning experience</p>
        </div>
    </div>
    
    <!-- Scanning Section -->
    <div id="scanning-section" class="card hidden">
        <h1>AR Camera Scanner</h1>
        <p>Point your camera at one of the learning posters</p>
        
        <div class="camera-container">
            <div class="viewfinder">
                <div class="viewfinder-frame">
                    <div class="corner top-left"></div>
                    <div class="corner top-right"></div>
                    <div class="corner bottom-left"></div>
                    <div class="corner bottom-right"></div>
                    <div class="scanning-line"></div>
                </div>
                <!-- AR Scene Container - will be populated by AR Scene Manager -->
                <div id="ar-scene-container" class="ar-scene-container">
                    <div class="camera-placeholder" id="camera-placeholder">
                        <span class="camera-icon">📷</span>
                        <p>Camera viewfinder</p>
                    </div>
                </div>
            </div>
            
            <div class="scanning-instructions">
                <div class="instruction-step">
                    <span class="step-icon">1️⃣</span>
                    <span>Hold your device steady</span>
                </div>
                <div class="instruction-step">
                    <span class="step-icon">2️⃣</span>
                    <span>Point at a learning poster</span>
                </div>
                <div class="instruction-step">
                    <span class="step-icon">3️⃣</span>
                    <span>Wait for poster detection</span>
                </div>
            </div>
        </div>
        
        <div class="permission-section">
            <button id="request-camera-btn" class="btn btn-primary" onclick="requestCameraPermission()">
                📱 Enable Camera Access
            </button>
            <p class="permission-note">Camera access is required for AR scanning</p>
        </div>
        

        
        <div class="error-section hidden">
            <div class="error-message">
                <span class="error-icon">⚠️</span>
                <p>Camera access denied. Please enable camera permissions to continue.</p>
            </div>
            <button class="btn btn-secondary" onclick="goBackToMenu()">
                ← Back to Menu
            </button>
        </div>
    </div>
    
    <!-- AR Ready Section -->
    <div id="ar-ready-section" class="card hidden">
        <h1>🎯 Poster Detected!</h1>
        <p>Great! We found a learning poster. Your AR experience is ready to begin.</p>
        
        <div class="detection-success">
            <div class="success-icon">✅</div>
            <div class="poster-info">
                <h3 id="detected-poster-title">Learning Poster Detected</h3>
                <p id="detected-poster-desc">Topic: <span id="detected-topic-name">Topic will be detected</span></p>
            </div>
        </div>
        
        <div class="ar-instructions">
            <h3>What happens next?</h3>
            <div class="instruction-list">
                <div class="instruction-item">
                    <span class="step-number">1</span>
                    <span>AR scene will load with interactive content</span>
                </div>
                <div class="instruction-item">
                    <span class="step-number">2</span>
                    <span>Explore the 3D learning environment</span>
                </div>
                <div class="instruction-item">
                    <span class="step-number">3</span>
                    <span>Complete interactive activities</span>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary" onclick="startARExperience()">
            🚀 Start AR Experience
        </button>
        
        <div class="ar-note">
            <p>💡 <strong>Tip:</strong> Keep your device steady and follow the on-screen instructions</p>
        </div>
    </div>
    
    <!-- Animating Section -->
    <div id="animating-section" class="card hidden">
        <h1>🚀 Loading AR Experience</h1>
        <p>Preparing your interactive learning environment...</p>
        
        <div class="ar-loading-container">
            <div class="ar-loading-animation">
                <div class="ar-spinner"></div>
                <div class="ar-pulse"></div>
            </div>
            
            <div class="loading-steps">
                <div class="loading-step" id="step-1">
                    <span class="step-icon">🔍</span>
                    <span class="step-text">Initializing AR scene...</span>
                    <span class="step-status">⏳</span>
                </div>
                <div class="loading-step" id="step-2">
                    <span class="step-icon">🎬</span>
                    <span class="step-text">Loading assets...</span>
                    <span class="step-status">⏳</span>
                </div>
                <div class="loading-step" id="step-3">
                    <span class="step-icon">🎮</span>
                    <span class="step-text">Setting up interactions...</span>
                    <span class="step-status">⏳</span>
                </div>
                <div class="loading-step" id="step-4">
                    <span class="step-icon">✨</span>
                    <span class="step-text">Finalizing experience...</span>
                    <span class="step-status">⏳</span>
                </div>
            </div>
            
            <div class="ar-progress-container">
                <div class="ar-progress-bar">
                    <div id="ar-progress-fill" class="ar-progress-fill"></div>
                </div>
                <div class="ar-progress-text">
                    <span id="ar-progress-percentage">0%</span> Complete
                </div>
            </div>
        </div>
        
        <div class="ar-loading-note">
            <p>🎯 <strong>Keep your device pointed at the poster</strong></p>
            <p>This ensures the AR experience loads correctly</p>
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div id="progress" class="hidden">
        <div class="back-link" onclick="goHome()">← Back to Topics</div>
        <div class="progress-bar">
            <div id="progress-bar" class="progress-fill"></div>
        </div>
    </div>
    
    <!-- Video Section -->
    <div id="video-section" class="card hidden">
        <h2 id="video-title">Topic Title</h2>
        
        <div class="video-container">
            <iframe src="" frameborder="0" allowfullscreen></iframe>
        </div>
        
        <div id="content-area">
            <!-- Content will be loaded here -->
        </div>
        
        <button class="btn" onclick="goToQuiz()">Continue to Quiz</button>
    </div>
    
    <!-- Quiz Section -->
    <div id="quiz-section" class="card hidden">
        <h2>Quiz Time!</h2>
        
        <div class="question-box">
            <h3 id="question">Loading question...</h3>
            <p id="instructions">Select your answer(s):</p>
        </div>
        
        <div id="answers">
            <!-- Answers will be loaded here -->
        </div>
        
        <button id="submit-btn" class="btn" onclick="checkAnswers()">Submit Answer</button>
        
        <div id="results" class="hidden">
            <div id="score" class="score-box">Score: 0%</div>
            <div id="feedback" class="feedback-box">Feedback will appear here</div>
            <button class="btn btn-success" onclick="goToSummary()">Continue</button>
        </div>
    </div>
    
    <!-- Summary Section -->
    <div id="summary-section" class="card hidden">
        <h2>Great Work!</h2>
        <div id="summary-content">
            <!-- Summary will be loaded here -->
        </div>
        <button class="btn btn-secondary" onclick="restartTopic()">Try Again</button>
        <button class="btn" onclick="goHome()">Choose New Topic</button>
    </div>

    <!-- AR Not Supported Modal -->
    <div id="ar-not-supported-message" class="ar-not-supported-message hidden">
        <div class="message-content">
            <h3>AR Scanning Not Available</h3>
            <p>Your device or browser doesn't support AR scanning.</p>
            <p>Please try on a mobile device with camera access for the full AR experience.</p>
            <button class="btn" onclick="restartApp()">Go Back</button>
        </div>
    </div>

    <!-- Core JavaScript Files - Load in dependency order -->
    <script src="./core/js/topics.js?v=2.4"></script>
    <script src="./core/js/stateManager.js?v=2.4"></script>
    <script src="./core/js/progressManager.js?v=2.4"></script>
    <script src="./core/js/mobile-console.js?v=2.4"></script>
    
    <!-- A-Frame Library - Required for 3D scenes and AR functionality -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    
    <!-- MindAR Library - Required for AR functionality -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script src="./core/js/arSceneManager.js?v=2.16"></script>
    
    <!-- Phase 4.5: Real AR Scene Implementation Active -->
    <script>
        /*
         * Main Application Script
         * 
         * Dependencies (loaded in order):
         * 1. topics.js - Topic data and content management
         * 2. stateManager.js - Application state management
         * 
         * This script contains:
         * - Global variables and state
         * - UI interaction functions
         * - State transition logic
         * - Loading simulations
         * - Content loading functions
         */
        
        let version = '2.17';
        let currentTopic = '';
        let selectedAnswers = [];
        let currentScore = 0;
        let selectedCampus = '';
        

        
        // Loading simulation function
        function simulateLoading() {
            let progress = 0;
            const progressBar = document.getElementById('loading-progress');
            const progressText = document.getElementById('loading-percentage');
            const loadingText = document.querySelector('.progress-text');
            
            // Check if required elements exist
            if (!progressBar || !progressText || !loadingText) {
                console.error('Loading elements not found, skipping simulation');
                // Fallback: just transition to campus selection
                setTimeout(() => {
                    stateManager.changeState('campus_selection');
                }, 500);
                return;
            }
            
            const loadingSteps = [
                { text: 'Initializing...', progress: 20 },
                { text: 'Loading AR components...', progress: 40 },
                { text: 'Preparing learning content...', progress: 60 },
                { text: 'Setting up interactive elements...', progress: 80 },
                { text: 'Almost ready...', progress: 100 }
            ];
            
            let currentStep = 0;
            
            const interval = setInterval(() => {
                progress += 2;
                
                // Check if currentStep is within bounds
                if (currentStep < loadingSteps.length && progress >= loadingSteps[currentStep].progress) {
                    if (loadingText) {
                        loadingText.textContent = loadingSteps[currentStep].text;
                    }
                    currentStep++;
                }
                
                // Update progress bar and text with null checks
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                if (progressText) {
                    progressText.textContent = progress + '%';
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        // Use state manager to transition to campus selection
                        stateManager.changeState('campus_selection');
                    }, 250);
                }
            }, 20);
        }
        
        // Populate topic cards dynamically from topics.js
        function populateTopicCards() {
            const container = document.getElementById('topic-grid-container');
            if (!container) return;
            
            // Clear existing cards
            container.innerHTML = '';
            
            // Create cards for topics 1-4
            for (let i = 1; i <= 4; i++) {
                const topicTitle = window.getTopicTitle ? window.getTopicTitle(i) : `Topic ${i}`;
                const topicIcon = window.getTopicIcon ? window.getTopicIcon(i) : '📚';
                
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.onclick = () => startTopic(`topic_${i}`);
                
                // Check if icon is an image path or emoji
                const iconElement = topicIcon.includes('.') ? 
                    `<img src="${topicIcon}" alt="Topic ${i}" class="topic-icon-img">` : 
                    `<span class="topic-icon">${topicIcon}</span>`;
                
                card.innerHTML = `
                    ${iconElement}
                    <div class="topic-title">${topicTitle}</div>
                    <div class="topic-desc">Interactive learning experience</div>
                `;
                
                container.appendChild(card);
            }
        }
        
        // Start loading when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set version in mobile console if it's available
            if (window.mobileConsole) {
                window.mobileConsole.setVersion(version);
            }
            
            simulateLoading();
            
            // Populate UI elements after a short delay to ensure topics.js is loaded
            setTimeout(() => {
                populateTopicCards();
            }, 100);
        });
        
        // Campus selection function
        function selectCampus(campus) {
            selectedCampus = campus;
            // Use state manager to transition directly to menu
            // AR scanning will automatically detect/simulate a topic
            stateManager.changeState('menu');
        }
        
        // Start AR scanning function
        function startARScanning() {
            console.log('🎬 App: Starting AR scanning process...');
            
            if (window.arSceneManager) {
                console.log('✅ App: AR Scene Manager found, connecting to state manager');
                window.arSceneManager.connectStateManager(stateManager);
                
                console.log('🚀 App: Initializing AR Scene Manager...');
                window.arSceneManager.initialize().then(() => {
                    console.log('✅ App: AR Scene Manager ready - transitioning to scanning state');
                    stateManager.changeState('scanning');
                }).catch(error => {
                    console.error('❌ App: Failed to initialize AR Scene Manager:', error);
                });
            } else {
                console.error('❌ App: AR Scene Manager not available');
            }
        }
        
        // Start AR experience function
        function startARExperience() {
            // Use state manager to transition to animating state
            stateManager.changeState('animating');
            
            // AR scene should already be created when poster was detected
            // Just start the loading simulation
            setTimeout(() => {
                simulateARLoading();
            }, 500);
        }
        
        // Simulate AR loading process
        function simulateARLoading() {
            let progress = 0;
            const progressBar = document.getElementById('ar-progress-fill');
            const progressText = document.getElementById('ar-progress-percentage');
            
            const loadingSteps = [
                { step: 1, text: 'Initializing AR scene...', progress: 25 },
                { step: 2, text: 'Loading assets...', progress: 50 },
                { step: 3, text: 'Setting up interactions...', progress: 75 },
                { step: 4, text: 'Finalizing experience...', progress: 100 }
            ];
            
            let currentStep = 0;
            
            const interval = setInterval(() => {
                progress += 1;
                
                // Update progress bar
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';
                
                // Check if we should move to next step
                if (progress >= loadingSteps[currentStep].progress) {
                    // Mark current step as completed
                    const stepElement = document.getElementById(`step-${loadingSteps[currentStep].step}`);
                    if (stepElement) {
                        stepElement.classList.remove('active');
                        stepElement.classList.add('completed');
                        stepElement.querySelector('.step-status').textContent = '✅';
                    }
                    
                    currentStep++;
                    
                    // If we have more steps, activate the next one
                    if (currentStep < loadingSteps.length) {
                        const nextStepElement = document.getElementById(`step-${loadingSteps[currentStep].step}`);
                        if (nextStepElement) {
                            nextStepElement.classList.add('active');
                            nextStepElement.querySelector('.step-status').textContent = '🔄';
                        }
                    }
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        // Transition to video state after loading completes
                        stateManager.changeState('video');
                        
                        // Load video content for the current topic
                        loadVideoContent();
                        updateProgress(33);
                    }, 250);
                }
            }, 20);
        }
        
        // Camera permission handling
        let permissionAttempts = 0;
        const MAX_PERMISSION_ATTEMPTS = 2;
        
        function requestCameraPermission() {
            permissionAttempts++;
            
            if (permissionAttempts <= MAX_PERMISSION_ATTEMPTS) {
                // Simulate permission request (placeholder for now)
                const btn = document.getElementById('request-camera-btn');
                btn.textContent = `📱 Requesting Camera Access... (${permissionAttempts}/${MAX_PERMISSION_ATTEMPTS})`;
                btn.disabled = true;
                
                // Simulate permission check after 2 seconds
                setTimeout(() => {
                    if (permissionAttempts < MAX_PERMISSION_ATTEMPTS) {
                        // Simulate permission denied, show retry
                        btn.textContent = `📱 Try Again (${permissionAttempts}/${MAX_PERMISSION_ATTEMPTS})`;
                        btn.disabled = false;
                        btn.onclick = requestCameraPermission;
                    } else {
                        // Max attempts reached, show error
                        showCameraError();
                    }
                }, 2000);
            } else {
                showCameraError();
            }
        }
        
        function showCameraError() {
            document.querySelector('.permission-section').classList.add('hidden');
            document.querySelector('.error-section').classList.remove('hidden');
        }
        
        function goBackToMenu() {
            // Reset permission attempts
            permissionAttempts = 0;
            // Go back to menu state
            stateManager.changeState('menu');
        }
        
        function startTopic(topic) {
            currentTopic = topic;
            selectedAnswers = [];
            currentScore = 0;
            
            // Use state manager to change to menu state
            stateManager.changeState('menu');
        }
        
        // Function to set current topic (called by mindarManager)
        function setCurrentTopic(topic) {
            currentTopic = topic;
            console.log(`🎯 Current topic set to: ${currentTopic}`);
        }
        
        function loadVideoContent() {
            // Use topics.js helper functions to get topic information
            const topicId = currentTopic.replace('topic_', '');
            const topicTitle = window.getTopicTitle ? window.getTopicTitle(topicId) : 'Learning Topic';
            const topicContent = window.getTopicContent ? window.getTopicContent(topicId) : ['Content will be loaded here.'];
            const topicVideoUrl = window.getTopicVideoUrl ? window.getTopicVideoUrl(topicId) : null;
            
            // Update video title
            document.getElementById('video-title').textContent = topicTitle;
            
            // Update video iframe source - let it fail if no URL
            const videoIframe = document.querySelector('#video-section iframe');
            if (videoIframe) {
                if (topicVideoUrl) {
                    videoIframe.src = topicVideoUrl;
                } else {
                    // No fallback - let the iframe remain empty/broken
                    videoIframe.src = '';
                    console.error(`No video URL found for topic: ${currentTopic}`);
                }
            }
            
            // Update content area
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';
            
            topicContent.forEach(paragraph => {
                const p = document.createElement('p');
                p.textContent = paragraph;
                contentArea.appendChild(p);
            });
        }
        
        function goToQuiz() {
            stateManager.changeState('quiz');
            
            loadQuiz();
            updateProgress(66);
        }
        
        function loadQuiz() {
            const topicId = currentTopic.replace('topic_', '');
            const question = window.getTopicQuestion ? window.getTopicQuestion(topicId) : 'Loading question...';
            const answers = window.getTopicAnswers ? window.getTopicAnswers(topicId) : [];
            
            document.getElementById('question').textContent = question;
            
            const answersDiv = document.getElementById('answers');
            answersDiv.innerHTML = '';
            
            answers.forEach((answer, index) => {
                const div = document.createElement('div');
                div.className = 'answer';
                div.textContent = answer.text;
                div.onclick = () => selectAnswer(index);
                answersDiv.appendChild(div);
            });
        }
        
        function selectAnswer(index) {
            const answerDiv = document.getElementsByClassName('answer')[index];
            
            if (selectedAnswers.includes(index)) {
                selectedAnswers = selectedAnswers.filter(i => i !== index);
                answerDiv.classList.remove('selected');
            } else {
                selectedAnswers.push(index);
                answerDiv.classList.add('selected');
            }
        }
        
        function checkAnswers() {
            const topicId = currentTopic.replace('topic_', '');
            const answers = window.getTopicAnswers ? window.getTopicAnswers(topicId) : [];
            const correctAnswers = answers.map((answer, index) => 
                answer.correct ? index : null).filter(i => i !== null);
            
            let correct = 0;
            let total = correctAnswers.length;
            
            // Count correct selections
            correctAnswers.forEach(correctIndex => {
                if (selectedAnswers.includes(correctIndex)) {
                    correct++;
                }
            });
            
            // Subtract for wrong selections
            selectedAnswers.forEach(selectedIndex => {
                if (!correctAnswers.includes(selectedIndex)) {
                    correct = Math.max(0, correct - 1);
                }
            });
            
            currentScore = Math.round((correct / total) * 100);
            
            // Show results
            showQuizResults(correctAnswers);
        }
        
        function showQuizResults(correctAnswers) {
            const topicId = currentTopic.replace('topic_', '');
            const answers = window.getTopicAnswers ? window.getTopicAnswers(topicId) : [];
            const feedback = window.getTopicFeedback ? window.getTopicFeedback(topicId) : { perfect: '', partial: '' };
            const answerElements = document.getElementsByClassName('answer');
            
            // Color code answers
            for (let i = 0; i < answerElements.length; i++) {
                const answer = answerElements[i];
                const wasSelected = selectedAnswers.includes(i);
                const isCorrect = correctAnswers.includes(i);
                
                answer.onclick = null; // Disable clicking
                answer.classList.remove('selected');
                
                if (isCorrect && wasSelected) {
                    answer.classList.add('correct');
                } else if (isCorrect && !wasSelected) {
                    answer.classList.add('missed');
                } else if (!isCorrect && wasSelected) {
                    answer.classList.add('incorrect');
                }
            }
            
            // Show score and feedback
            document.getElementById('score').textContent = `Score: ${currentScore}%`;
            
            const feedbackText = currentScore === 100 ? feedback.perfect : feedback.partial;
            document.getElementById('feedback').textContent = feedbackText;
            
            document.getElementById('submit-btn').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
        }
        
        function goToSummary() {
            stateManager.changeState('summary');
            
            loadSummary();
            updateProgress(100);
        }
        
        function loadSummary() {
            const topicId = currentTopic.replace('topic_', '');
            const summary = window.getTopicSummary ? window.getTopicSummary(topicId) : [];
            const summaryDiv = document.getElementById('summary-content');
            summaryDiv.innerHTML = '';
            
            summary.forEach(line => {
                const p = document.createElement('p');
                p.textContent = line;
                summaryDiv.appendChild(p);
            });
            
            // Add final score
            const scoreP = document.createElement('div');
            scoreP.className = 'score-box';
            scoreP.textContent = `Final Score: ${currentScore}%`;
            scoreP.style.marginTop = '20px';
            summaryDiv.appendChild(scoreP);
            
            // Mark topic as completed when summary is viewed
            if (window.progressManager && topicId) {
                const topicNumber = parseInt(topicId);
                window.progressManager.markTopicCompleted(topicNumber);
                console.log(`Topic ${topicNumber} marked as completed after viewing summary`);
            }
        }
        
        function restartTopic() {
            selectedAnswers = [];
            currentScore = 0;
            
            // Reset quiz
            document.getElementById('submit-btn').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            
            // Use state manager to return to video state
            stateManager.changeState('video');
            
            loadVideoContent();
            updateProgress(33);
        }
        
        function restartApp() {
            // Hide the AR not supported message
            const messageContainer = document.getElementById('ar-not-supported-message');
            if (messageContainer) {
                messageContainer.classList.add('hidden');
            }
            
            // Go back to topics selection
            stateManager.changeState('topics');
        }
        
        function goHome() {
            // Reset everything
            selectedAnswers = [];
            currentScore = 0;
            currentTopic = '';
            selectedCampus = '';
            
            // Use state manager to return to campus selection state
            stateManager.changeState('menu');
            
            // Reset quiz state
            document.getElementById('submit-btn').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
        }
        
        function updateProgress(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }
        
        /*
         * End of Main Application Script
         * 
         * All UI sections, state management, and user interactions are now implemented
         * The app provides a complete flow from loading through AR scanning to video/quiz/summary
         */
    </script>
</body>
</html>